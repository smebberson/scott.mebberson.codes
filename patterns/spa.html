<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link href="https://fonts.googleapis.com/css?family=Bungee|Bungee+Shade|Libre+Barcode+128|Open+Sans:300,400,700" rel="stylesheet" class="jsx-1858778926"/><script src="https://embed.runkit.com" class="jsx-1858778926"></script><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/KE3b5CK2nY0BRzm2f6Cyr/pages/patterns/spa.js" as="script"/><link rel="preload" href="/_next/static/KE3b5CK2nY0BRzm2f6Cyr/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-b65cab0b00afd201cbda.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.6896da6a3cbf3395369b.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.d528cee6b97a90c9f539.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-423f1eb7bcbd697edcd9.js" as="script"/><link rel="preload" href="/_next/static/chunks/cde53206dcfbfe9d6bdc9c1c8fe1551b62fa291e.7684b2b9fac1ed00297e.js" as="script"/><style id="__jsx-2011485720">ul.jsx-2011485720{margin:30px 0px;padding:0px;}li.jsx-2011485720{display:inline;font-weight:200;list-style-type:none;margin:0px 5px;text-transform:uppercase;}a.jsx-2011485720{border:1px solid #DFDFDF;border-radius:20px;color:#333;font-size:0.9rem;-webkit-letter-spacing:2px;-moz-letter-spacing:2px;-ms-letter-spacing:2px;letter-spacing:2px;padding:10px 15px;-webkit-text-decoration:none;text-decoration:none;}</style><style id="__jsx-2543978347">header.jsx-2543978347{margin-top:3em;margin-bottom:4em;}h1.jsx-2543978347{text-transform:uppercase;font-weight:600;}</style><style id="__jsx-2878587659">header.jsx-2878587659{background-color:#FF5050;}</style><style id="__jsx-3740271250">header.jsx-3740271250{margin-bottom:3em;padding:6em 0px 3em 0px;position:relative;}time.jsx-3740271250{font-size:0.8em;font-weight:600;position:absolute;top:4.2em;}h1.jsx-3740271250{font-family:'Bungee Shade',sans-serif;font-size:5em;margin:0px;text-align:left;}p.jsx-3740271250{font-family:'Libre Barcode 128',sans-serif;font-size:2em;line-height:0px;margin:0px;}span.jsx-3740271250{display:block;margin-top:0.5em;}</style><style id="__jsx-1083602474">.heading.jsx-1083602474{text-transform:uppercase;font-weight:600;}</style><style id="__jsx-3947944616">.sub-heading.jsx-3947944616{text-transform:uppercase;font-size:1.2em;font-weight:600;}</style><style id="__jsx-3161884056">code.jsx-3161884056{color:deepPink;font-family:Menlo,Monaco,monospace,serif;font-size:0.9em;}code.jsx-3161884056::before{content:'\`';}code.jsx-3161884056::after{content:'\`';}</style><style id="__jsx-568704045">h1.jsx-1858778926{font-weight:600;text-transform:uppercase;-webkit-letter-spacing:2px;-moz-letter-spacing:2px;-ms-letter-spacing:2px;letter-spacing:2px;}div.jsx-1858778926{margin-bottom:5em;}</style><style id="__jsx-3488521514">body{font-family:'Open sans',sans-serif;font-size:16px;font-weight:300;margin:0;padding:0;}.constrained{margin:0 auto;width:80%;max-width:720px;}.align-center{text-align:center;}.icon{width:1em;}.icon.good{color:#89c472;}.icon.bad{color:#fc6c85;}.code .icon{position:absolute;left:-25px;top:5px;}.code.with-runkit .icon{left:-40px;}</style></head><body><div id="__next"><div class="jsx-1858778926 "><header class="jsx-2543978347 constrained align-center"><h1 class="jsx-2543978347">scott.mebberson.codes</h1><nav class="jsx-2011485720"><ul class="jsx-2011485720"><li class="jsx-2011485720"><a class="jsx-2011485720" href="/cheat-sheets">Cheat Sheets</a></li><li class="jsx-2011485720"><a class="jsx-2011485720" href="/patterns">Patterns</a></li><li class="jsx-2011485720"><a class="jsx-2011485720" href="/about">About</a></li></ul></nav></header><header class="jsx-3740271250 jsx-2878587659"><div class="jsx-3740271250 jsx-2878587659 constrained"><time class="jsx-3740271250 jsx-2878587659"></time><p class="jsx-3740271250 jsx-2878587659">SPA<br/></p><h1 class="jsx-3740271250 jsx-2878587659">SPA<br/></h1></div></header><div class="constrained"><h2 class="jsx-1083602474 heading">JWT Authentication</h2><p>The basic premise of this JWT authentication pattern is that the front-end authenticates via a GraphQL API with a valid JWT on each request.</p><p>Attributes of this pattern include:</p><ul><li>Using a JWT.</li><li>Splitting the JWT across two cookies.</li><li>Ensuring the entire JWT is not available to JavaScript.</li><li>Works with and without a browser (with and without cookies).</li></ul><h2 class="jsx-3947944616 sub-heading">Using a JWT.</h2><p>A valid JWT will act as the currency for an authenticated user.</p><p>The first step is to authenticate the user and issue a valid JWT. This step is required in both browser and non-browser contexts.</p><iframe style="border:none" width="800" height="450" src="https://whimsical.com/embed/SbMorpCErV6dxWZH9Jhioq"></iframe><h2 class="jsx-3947944616 sub-heading">Splitting the cookie.</h2><p>Now that the client has a valid JWT, it will need to be sent with each request to the GraphQL API.</p><p>Storing JWTs in a SPA is notoriously tricky. Most of the options present a security risk as the entire JWT ends up being available to JavaScript. As such, retrieval of the JWT might be possible with common exploits such as cross-site scripting.</p><p>To avoid these scenarios, we&#x27;ll split the JWT content (<code class="jsx-3161884056 ">{<!-- -->header<!-- -->}<!-- -->.<!-- -->{<!-- -->payload<!-- -->}<!-- -->.<!-- -->{<!-- -->signature<!-- -->}</code>) across two cookies.</p><p>The first cookie will contain the<!-- --> <code class="jsx-3161884056 ">{<!-- -->header<!-- -->}<!-- -->.<!-- -->{<!-- -->payload<!-- -->}</code> <!-- -->content from the JWT with the following attributes:</p><ul><li>Expiry: 30 minutes</li><li>SameSite: Lax</li><li>Secure: yes</li></ul><p>The second cookie will contain the<!-- --> <code class="jsx-3161884056 ">{<!-- -->signature<!-- -->}</code> <!-- -->content from the JWT with the following attributes:</p><ul><li>Expiry: session</li><li>HTTPOnly: yes</li><li>SameSite: Lax</li><li>Secure: yes</li></ul><p>Splitting the JWT across two cookies provides the following benefits:</p><ul><li>The entire JWT never exists in JavaScript.</li><li>JavaScript can still extract user information from a cookie containing the <code class="jsx-3161884056 ">payload</code> portion of the JWT.</li><li>Each request made in a browser context will automatically include all authentication content.</li><li>The <code class="jsx-3161884056 ">signature</code> cookie is<!-- --> <code class="jsx-3161884056 ">HTTPOnly</code> so it is not available to JavaScript and helps to protect against XSS.</li><li>Using <code class="jsx-3161884056 ">SameSite</code> <code class="jsx-3161884056 ">Lax</code> cookies will provide some protection against CSRF.</li><li>Using <code class="jsx-3161884056 ">Secure</code> cookies will help to mitigate man-in-the-middle attacks.</li></ul><h2 class="jsx-3947944616 sub-heading">Optionally, reconstructing the JWT</h2><p>Each request to the GraphQL API will need to be authenticated with a valid JWT.</p><p>Browsers will supply the JWT via two cookies, and API clients will provide the JWT via an <code class="jsx-3161884056 ">Authorization</code> header.</p><p>The GraphQL API will need to respond to all requests, regardless if they&#x27;re coming from a browser or not.</p><p>In the context of an API client, an <code class="jsx-3161884056 ">Authorization</code> <!-- -->header containing a JWT will be supplied.</p><p>In the context of the browser, the server will be responsible for creating an <code class="jsx-3161884056 ">Authorization</code> header by reconstructing a JWT from the content within the two cookies. Constructing the<!-- --> <code class="jsx-3161884056 ">Authorization</code> header will ensure that all future processing of the request is identical for browser-based and non-browser-based applications alike.</p><p>Each request should be inspected for cookies and if found, their content to be used in reconstructing the JWT and creating an<code class="jsx-3161884056 ">Authorization</code> header.</p><iframe style="border:none" width="800" height="450" src="https://whimsical.com/embed/NEi2VS4ijQaV6UnnLucAbE"></iframe><h2 class="jsx-3947944616 sub-heading">Guarding against CSRF</h2><p>While using cookies to store the JWT (rather than storing it in local storage or session storage) protects applications from some type of attacks, it makes them vulnerable to others, including CSRF.</p><p>Using the<!-- --> <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank">Same Origin Policy (SOP)</a>, we can mitigate CSRF by requiring that a custom header exists if supplying the JWT via cookies. This is described as a<!-- --> <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#use-of-custom-request-headers" target="_blank">CSRF prevention technique on OWASP</a>.</p><p>Processing of the cookies should only take place if a custom header with the correct information is supplied.</p><iframe style="border:none" width="800" height="450" src="https://whimsical.com/embed/CV9FRF4i53hnMqKUXJjrJm"></iframe><h2 class="jsx-3947944616 sub-heading">Validating the JWT</h2><p>The GraphQL API should require a valid JWT in the<!-- --> <code class="jsx-3161884056 ">Authorization</code> header.</p><p>When validating the JWT, ensuring the following are checked:</p><ul><li>Verify the issuer.</li><li>Verify the audience.</li><li>Ensure the token is not expired.</li></ul><h2 class="jsx-3947944616 sub-heading">Continue processing</h2><p>At this point, if the JWT validated and the user roles have access to the GraphQL API queries being requested, continue processing the request using your GraphQL framework.</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/patterns/spa","query":{},"buildId":"KE3b5CK2nY0BRzm2f6Cyr","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/runtime/polyfills-c0e011eba1c8c0f9284f.js"></script><script async="" data-next-page="/patterns/spa" src="/_next/static/KE3b5CK2nY0BRzm2f6Cyr/pages/patterns/spa.js"></script><script async="" data-next-page="/_app" src="/_next/static/KE3b5CK2nY0BRzm2f6Cyr/pages/_app.js"></script><script src="/_next/static/runtime/webpack-b65cab0b00afd201cbda.js" async=""></script><script src="/_next/static/chunks/framework.6896da6a3cbf3395369b.js" async=""></script><script src="/_next/static/chunks/commons.d528cee6b97a90c9f539.js" async=""></script><script src="/_next/static/runtime/main-423f1eb7bcbd697edcd9.js" async=""></script><script src="/_next/static/chunks/cde53206dcfbfe9d6bdc9c1c8fe1551b62fa291e.7684b2b9fac1ed00297e.js" async=""></script><script src="/_next/static/KE3b5CK2nY0BRzm2f6Cyr/_buildManifest.js" async=""></script><script src="/_next/static/KE3b5CK2nY0BRzm2f6Cyr/_ssgManifest.js" async=""></script></body></html>